<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soal Psikotest</title>
    <script>
        if (!localStorage.getItem('user')) {
            window.location.href = 'login.html';
        }
    </script>
    <!-- CSS yang diambil dari file eksternal -->
    <link rel="stylesheet" href="css_tes.css">
    <style>
        /* Gaya tambahan untuk kompatibilitas */
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            h1 {
                margin-bottom: 0px;
                margin-top: -10px;
            }
            #question {
                margin-top: -50px;
            }
            .options {
                gap: 0px;
            }
        }
    </style>
</head>
<body>

    <div class="quiz-container">
        <div class="keterangan_soal">
            <h1>Keterangan Soal</h1>
            <p>Pada subtes 4 ini agak berbeda dengan 3 subtes sebelumnya. Harap anda perhatikan instruksi saya, jika anda lihat maka ada kotak disebelah kiri dan kotak pilihan jawaban di sebelah kanannya. Ada 3 unsur bentuk dalam kotak sebelah kiri. Titik, dan 2 bentuk lainnya. Tugas anda adalah memilih gambar dimana anda dapat meletakkan posisi titik yang tidak berbeda komposisinya dengan gambar contoh.</p>
            <h2>Contoh 1</h2>
            <img src="https://latihan1.pages.dev/01/test/gambar/cfit4a.png" alt="">
            <h2>Contoh 2</h2>
            <img src="https://latihan1.pages.dev/01/test/gambar/cfit4b.png" alt="">
            <h2>Penjelasan Jawaban</h2>
            <b>Contoh pertama</b>
            <p>Pada gambar sebelah kiri (stimulus), titik yang perlu dibayangkan terletak di dalam area yang memiliki dua bentuk sekaligus, yaitu persegi dan lingkaran.  Pilihan jawaban a, b, c, d, & e terdiri dari beberapa gambar yang memiliki berbagai kombinasi bentuk. Tugas anda adalah mencari gambar yang memiliki persegi dan lingkaran yang saling berpotongan, serta memastikan ada area di mana titik bisa diletakkan di dalam kedua bentuk tersebut secara bersamaan sesuai dengan contoh disebelah kiri. Pilihan (c) adalah jawaban yang benar karena gambar ini memiliki persegi dan lingkaran yang saling berpotongan, sama seperti pada stimulus. Jawaban (c) adalah pilihan yang benar karena posisi titik dalam gambar tersebut sesuai dengan aturan yang telah ditetapkan, yaitu harus berada di dalam area yang memiliki dua bentuk sekaligus (persegi dan lingkaran).</p>
            <b>Contoh kedua</b>
            <p>Pada gambar sebelah kiri (stimulus), titik yang perlu dibayangkan berada di dalam segitiga tetapi di luar persegi panjang. Pilihan jawaban terdiri dari beberapa gambar dengan kombinasi bentuk yang berbeda. Tugas anda adalah mencari gambar yang memiliki segitiga dan persegi panjang, dengan area dalam segitiga tetapi di luar persegi panjang yang memungkinkan titik ditempatkan di sana. Pilihan (d) adalah jawaban yang benar karena dalam gambar tersebut, segitiga dan persegi panjang memiliki hubungan yang sama seperti pada stimulus, yaitu ada bagian segitiga yang berada di luar persegi panjang. Jawaban (d) adalah pilihan yang benar karena posisi titik dalam gambar tersebut sesuai dengan ketentuan soal, yaitu harus berada di dalam segitiga tetapi di luar persegi panjang.</p>
        <h1>Kerjakan Dengan Teliti</h1>
        </div>
        <button id="startButton" onclick="startGame()">Start</button>
        <div id="question" class="hidden"></div>
        <div class="options hidden"></div>
        <div id="timer">Waktu Tersisa: 210 detik</div>
        <div class="result" id="result"></div>
    </div>

    <script>
        let correctScore = 0;
        let wrongScore = 0;
        let timeLeft = 210;
        let currentQuestionIndex = 0;
        let questions = [];
        let userAnswers = [];
        let timerInterval;

        // Konfigurasi API untuk menyimpan hasil
        const API_URL = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis';
        const TABLE_NAME = 'nilai1';
        const ID_TO_UPDATE = parseInt(localStorage.getItem('id_x')); // ID data yang akan di-update

        // Mendefinisikan URL dasar untuk file pertanyaan
        const QUESTIONS_URL = 'https://latihan1.pages.dev/01/test/psikotest/cfit4.txt';
        // Mendefinisikan URL dasar untuk gambar
        const IMAGES_BASE_URL = 'https://latihan1.pages.dev/01/test/';

        // Mengirim hasil kuis ke API dengan memperbarui elemen keempat dari kolom x_05 dan x_08.
        async function sendResultToApi(score, answers) {
            const id = ID_TO_UPDATE;
            const resultDiv = document.getElementById("result");
            
            // Tampilkan pesan loading
            resultDiv.innerHTML = `<p style="color: blue;">Memproses data dan mengirim ke server...</p>`;

            try {
                // Langkah 1: Ambil data yang ada dari API
                const getUrl = `${API_URL}?table=${TABLE_NAME}&id_x_eq=${id}`;
                console.log('Fetching existing data from URL:', getUrl);
                const getResponse = await fetch(getUrl, {
                    method: 'GET',
                    headers: {
                        'X-Table-Name': TABLE_NAME
                    }
                });

                if (!getResponse.ok) {
                    throw new Error(`Gagal mengambil data dari API, status: ${getResponse.status}`);
                }
                const existingData = await getResponse.json();

                if (!existingData.data || existingData.data.length === 0) {
                    throw new Error('Data tidak ditemukan untuk ID yang diberikan.');
                }

                // Ambil nilai x_05 dan x_08 yang sudah ada
                let x05 = existingData.data[0].x_05 || '';
                let x08 = existingData.data[0].x_08 || '';

                // Langkah 2 & 3: "Explode" string, perbarui elemen keempat (indeks 3)
                let x05Parts = x05.split('|');
                while (x05Parts.length <= 3) { // Pastikan array memiliki setidaknya 4 elemen (indeks 3)
                    x05Parts.push('');
                }
                x05Parts[3] = `${score}`;
                let newX05Value = x05Parts.join('|');

                let x08Parts = x08.split('|');
                while (x08Parts.length <= 3) { // Pastikan array memiliki setidaknya 4 elemen (indeks 3)
                    x08Parts.push('');
                }
                x08Parts[3] = answers.join(', ');
                let newX08Value = x08Parts.join('|');
                
                // Langkah 4: Siapkan data untuk permintaan PUT
                const formData = {
                    x_05: newX05Value,
                    x_08: newX08Value
                };

                // Langkah 5: Kirim permintaan PUT ke API
                const putUrl = `${API_URL}?table=${TABLE_NAME}&id_x=${id}`;
                console.log('Updating data via PUT to URL:', putUrl);
                console.log('Data to be sent:', formData);
                
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Table-Name': TABLE_NAME
                    },
                    body: JSON.stringify(formData)
                });

                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(errorData.error || `HTTP error! status: ${putResponse.status}`);
                }

                const data = await putResponse.json();
                console.log('Save API response:', data);

                // Perbarui pesan di UI setelah sukses
                resultDiv.innerHTML = `<p style="color: green;">Data berhasil disimpan!</p>`;

                // Alihkan ke index.html setelah 2 detik
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving data:', error);
                // Perbarui pesan di UI jika terjadi error
                resultDiv.innerHTML = `<p style="color: red;">Error menyimpan data: ${error.message || error}</p>`;
            }
        }

        // Muat status permainan dari localStorage
        function loadGameState() {
            const savedState = localStorage.getItem('gameCfit4');
            if (savedState) {
                const state = JSON.parse(savedState);
                correctScore = state.correctScore || 0;
                wrongScore = state.wrongScore || 0;
                currentQuestionIndex = state.currentQuestionIndex || 0;
                userAnswers = state.userAnswers || [];
                timeLeft = state.timeLeft || 210;
            }
        }

        // Simpan status permainan ke localStorage
        function saveGameState() {
            const gameState = {
                correctScore: correctScore,
                wrongScore: wrongScore,
                currentQuestionIndex: currentQuestionIndex,
                userAnswers: userAnswers,
                timeLeft: timeLeft
            };
            localStorage.setItem('gameCfit4', JSON.stringify(gameState));
        }

        function endGame(timeout) {
            clearInterval(timerInterval);
            document.querySelector(".options").classList.add("hidden");

            let finalMessage = "";
            if (timeout) {
                finalMessage = "Waktu Habis! Kuis selesai.";
            } else {
                finalMessage = "Soal telah selesai!";
            }

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `
            <div style="text-align: center;">
            <h2>${finalMessage}</h2>
            <p id="apiStatus">Data sedang dikirim ke server...</p>
            </div>
            `;
            
            // Panggil fungsi untuk mengirim data ke API
            sendResultToApi(correctScore, userAnswers);

            localStorage.removeItem('gameCfit4');
        }

        function skipQuestion() {
            questions.push(questions[currentQuestionIndex]);
            currentQuestionIndex++;
            newQuestion();
            saveGameState();
        }

        function newQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame(false);
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer;

            // Ambil URL gambar dari pertanyaan
            const questionText = currentQuestion.question;
            const questionImageSrc = questionText.substring(questionText.indexOf(' ') + 1);

            // Tampilkan pertanyaan (nomor dan gambar)
            document.getElementById("question").innerHTML = `<div>${questionText.split(' ')[0]}.</div><img class="question-image" src="${IMAGES_BASE_URL}${questionImageSrc}" alt="">`;

            const optionsDiv = document.querySelector(".options");
            optionsDiv.innerHTML = ""; // Bersihkan opsi sebelumnya

            // Buat gambar untuk setiap opsi
            for (const optionKey in currentQuestion.options) {
                if (currentQuestion.options[optionKey] !== undefined) {
                    const img = document.createElement("img");
                    img.src = `${IMAGES_BASE_URL}${currentQuestion.options[optionKey]}`;
                    img.alt = `${optionKey}`;
                    img.classList.add('option-img');
                    img.onclick = () => submitAnswer(optionKey, correctAnswer);
                    optionsDiv.appendChild(img);
                }
            }

            // Tambahkan tombol lewati
            const skipButton = document.createElement("button");
            skipButton.innerHTML = "Lewati";
            skipButton.onclick = skipQuestion;
            optionsDiv.appendChild(skipButton);
        }

        function submitAnswer(option, correctAnswer) {
            const questionNumber = questions[currentQuestionIndex].question.split('.')[0];
            const resultIndicator = (option === correctAnswer) ? 'v' : 'x';
            userAnswers.push(`${questionNumber}${option}${resultIndicator}`);

            if (option === correctAnswer) {
                correctScore++;
            } else {
                wrongScore++;
            }

            currentQuestionIndex++;
            saveGameState();
            newQuestion();
        }
        
        function startGame() {
            document.querySelector(".keterangan_soal").classList.add("hidden");
            document.getElementById("startButton").disabled = true;
            document.querySelector("h1").classList.add("hidden");
            startTimer();
            newQuestion();
            document.querySelector(".options").classList.remove("hidden");
            document.getElementById("question").classList.remove("hidden");
        }
        
        function startTimer() {
            timerInterval = setInterval(function() {
                timeLeft--;
                document.getElementById("timer").innerHTML = "Waktu Tersisa: " + timeLeft + " detik";
                saveGameState();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(true);
                }
            }, 1000);
        }

        // Mengambil pertanyaan dari file cfit4.txt
        fetch(QUESTIONS_URL)
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal memuat pertanyaan: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            questions = data;
            loadGameState();
        })
        .catch(error => {
            console.error('Error fetching the questions:', error);
            document.getElementById("question").innerHTML = "Gagal memuat soal. Pastikan Anda menjalankan file ini di server web.";
            document.getElementById("question").classList.remove("hidden");
            document.getElementById("startButton").disabled = true;
        });

        loadGameState();
    </script>

</body>
</html>
