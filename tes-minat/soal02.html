<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soal Psikotest</title>
    <script>
        if (!localStorage.getItem('user')) {
            window.location.href = 'login.html';
        }
    </script>
    <!-- Menghubungkan ke file CSS eksternal -->
    <link rel="stylesheet" href="css_tes.css">
</head>
<body>

    <div class="quiz-container">
        <div class="keterangan_soal">
        <h1>Keterangan Soal</h1>
        <p>Pada setiap soal, Anda akan menemukan 5 buah gambar. Tugas Anda ialah menemukan 2 gambar yang memiliki karakteristik yang serupa. Tiga gambar lainnya berfungsi sebagai pengecoh Anda, sehingga telitilah dalam menentukan pilihan.</p>
        <h2>Contoh 1</h2>
        <img src="https://latihan1.pages.dev/01/test/gambar/cfit2a.png" alt="">
        <h2>Contoh 2</h2>
        <img src="https://latihan1.pages.dev/01/test/gambar/cfit2b.png" alt="">
        <h2>Penjelasan Jawaban</h2>
        <b>Contoh pertama</b>
        <p>Dalam subtes ini, Anda diminta untuk memilih dua bentuk yang berbeda dari tiga bentuk lainnya. Perhatikan dengan seksama bentuk-bentuk yang diberikan di dalam kotak. Jika dianalisa, diketahui bahwa gambar A, C, dan E memiliki bentuk segitiga sedangkan gambar B dan D memiliki bentuk segi empat. Karena sebagian besar gambar dalam deretan kotak ini adalah segitiga, maka dua gambar yang berbeda harus memiliki bentuk yang bukan segitiga. Gambar B dan D adalah segi empat, sedangkan yang lainnya adalah segitiga. Oleh karena itu, jawaban yang benar adalah B dan D, karena mereka berbeda dari pola mayoritas.</p>
        <b>Contoh kedua</b>
        <p>Perhatikan dengan seksama bentuk-bentuk yang diberikan di contoh kedua ini. Jika dianalisa, diketahui bahwa gambar A, B, dan D memiliki bentuk lingkaran kosong yang tidak ada pola didalamnya, sedangkan gambar C dan E memiliki bentuk lingkaran namun ada pola polkadot/titik-titik hitam didalamnya. Karena sebagian besar gambar dalam deretan kotak ini adalah lingkaran kosong, maka dua gambar yang berbeda harus memiliki bentuk yang bukan lingkaran kosong. Gambar C dan E adalah lingkaran dengan pola polkadot/titik-titik hitam, sedangkan yang lainnya adalah lingkaran kosong. Oleh karena itu, jawaban yang benar adalah C dan E, karena mereka berbeda dari pola mayoritas</p>
        <h1>Kerjakan Dengan Teliti</h1>
    </div>
        <button id="startButton" onclick="startGame()">Start</button>
        <div id="question" class="hidden"></div>
        <div class="options hidden"></div>
        <div class="tengah">
            <button onclick="calculateScore()" class="hidden" id="scoreButton" disabled>Jawab</button>
            <button onclick="skipQuestion()" class="hidden" id="skipButton">Lewati</button>
        </div>
        <div class="result" id="result"></div>
        <div id="timer">Waktu Tersisa: 300 detik</div>
    </div>

    <script>
        let correctScore = 0;
        let timeLeft = 300;
        let currentQuestionIndex = 0;
        let timerInterval;
        let allSelectedAnswers = [];
        let questions = [];
        
        // Konfigurasi API untuk menyimpan hasil
        const API_URL = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis';
        const TABLE_NAME = 'nilai1';
        const ID_TO_UPDATE = parseInt(localStorage.getItem('id_x')); // ID data yang akan di-update

        // Mendefinisikan URL dasar untuk file pertanyaan
        const QUESTIONS_URL = 'https://latihan1.pages.dev/01/test/psikotest/cfit2_a.txt';
        // Mendefinisikan URL dasar untuk gambar
        const IMAGES_BASE_URL = 'https://latihan1.pages.dev/01/test/';

        // Mengambil pertanyaan dari file cfit2_a.txt
        fetch(QUESTIONS_URL)
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal memuat pertanyaan: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            questions = data;
            loadGameState();
        })
        .catch(error => {
            console.error('Error fetching the questions:', error);
            document.getElementById("question").innerHTML = "Gagal memuat soal. Pastikan Anda menjalankan file ini di server web.";
            document.getElementById("question").classList.remove("hidden");
            document.getElementById("startButton").disabled = true;
        });
        
        // Muat status permainan dari localStorage
        function loadGameState() {
            const savedState = localStorage.getItem('gameCfit2');
            if (savedState) {
                const state = JSON.parse(savedState);
                correctScore = state.correctScore || 0;
                currentQuestionIndex = state.currentQuestionIndex || 0;
                allSelectedAnswers = state.allSelectedAnswers || [];
                timeLeft = state.timeLeft || 300;
            }
        }

        // Simpan status permainan ke localStorage
        function saveGameState() {
            const gameState = {
                correctScore: correctScore,
                currentQuestionIndex: currentQuestionIndex,
                allSelectedAnswers: allSelectedAnswers,
                timeLeft: timeLeft
            };
            localStorage.setItem('gameCfit2', JSON.stringify(gameState));
        }

        function startGame() {
            document.querySelector(".keterangan_soal").classList.add("hidden");
            loadGameState();
            document.getElementById("startButton").disabled = true;
            document.querySelector("h1").classList.add("hidden");
            startTimer();
            loadQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(function() {
                timeLeft--;
                document.getElementById("timer").innerHTML = "Waktu Tersisa: " + timeLeft + " detik";
                saveGameState();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(true);
                }
            }, 1000);
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame(false);
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            document.getElementById("question").innerHTML = "Ada 5 gambar. 2 gambar berbeda dan 3 gambar lainnya sama. Tentukan 2 gambar yang berbeda.";
            document.getElementById("question").classList.remove("hidden");
            const optionsDiv = document.querySelector(".options");
            optionsDiv.innerHTML = "";

            currentQuestion.options.forEach((option, index) => {
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = `option${currentQuestionIndex}-${index}`;
                checkbox.value = option;
                
                checkbox.addEventListener('change', function() {
                    const checkedCheckboxes = Array.from(document.querySelectorAll('.options input[type="checkbox"]:checked'));
                    document.getElementById("scoreButton").disabled = checkedCheckboxes.length < 2 || checkedCheckboxes.length > 2;
                });

                const label = document.createElement("label");
                label.htmlFor = `option${currentQuestionIndex}-${index}`;
                label.innerHTML = `<img src="${IMAGES_BASE_URL}${option}" alt="Option Image" class="option-img">`;

                optionsDiv.appendChild(checkbox);
                optionsDiv.appendChild(label);
            });
            
            optionsDiv.classList.remove("hidden");
            document.getElementById("scoreButton").classList.remove("hidden");
            document.getElementById("scoreButton").disabled = true;
            document.getElementById("skipButton").classList.remove("hidden");
        }

        function skipQuestion() {
            questions.push(questions[currentQuestionIndex]);
            currentQuestionIndex++;
            loadQuestion();
            saveGameState();
        }

        function calculateScore() {
            const selectedAnswers = [];
            const correctAnswers = questions[currentQuestionIndex].correctAnswers;

            const checkboxes = document.querySelectorAll('.options input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedAnswers.push(checkbox.value);
            });
            
            const questionNumber = currentQuestionIndex + 1;
            const formattedAnswers = selectedAnswers.map(answer => {
                const isCorrect = correctAnswers.includes(answer);
                // Menyesuaikan format untuk CFIT 2 (misal: 1A v, 1B x)
                const answerLetter = answer.match(/(\w)\.jpg/)[1];
                return `${questionNumber}${answerLetter} ${isCorrect ? 'v' : 'x'}`;
            });
            
            allSelectedAnswers.push(formattedAnswers);

            const isCorrect = selectedAnswers.length === correctAnswers.length && selectedAnswers.every(ans => correctAnswers.includes(ans));
            if (isCorrect) {
                correctScore++;
            }

            currentQuestionIndex++;
            loadQuestion();
            saveGameState();
        }

        function endGame(timeout) {
            clearInterval(timerInterval);

            // Menghapus tombol
            document.querySelector(".tengah").classList.add("hidden");
            document.querySelector(".options").classList.add("hidden");

            let finalMessage = "";
            if (timeout) {
                finalMessage = "Waktu Habis! Kuis selesai.";
            } else {
                finalMessage = "Soal telah selesai!";
            }

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `
                <div style="text-align: center;">
                    <h2>${finalMessage}</h2>
                    <p id="apiStatus">Data sedang dikirim ke server...</p>
                </div>
            `;
            
            // Panggil fungsi untuk mengirim data ke API
            sendResultToApi(correctScore, allSelectedAnswers);

            localStorage.removeItem('gameCfit2');
        }
        
        /**
         * Mengirim hasil kuis ke API dengan memperbarui elemen kedua dari kolom x_05 dan x_08.
         * @param {number} score - Skor jawaban yang benar.
         * @param {string[]} answers - Array dari jawaban pengguna.
         */
        async function sendResultToApi(score, answers) {
            const id = ID_TO_UPDATE;
            const apiStatusDiv = document.getElementById("apiStatus");
            
            // Tampilkan pesan loading
            apiStatusDiv.innerHTML = `<p style="color: blue;">Memproses data dan mengirim ke server...</p>`;

            try {
                // Langkah 1: Ambil data yang ada dari API
                const getUrl = `${API_URL}?table=${TABLE_NAME}&id_x_eq=${id}`;
                console.log('Fetching existing data from URL:', getUrl);
                const getResponse = await fetch(getUrl, {
                    method: 'GET',
                    headers: {
                        'X-Table-Name': TABLE_NAME
                    }
                });

                if (!getResponse.ok) {
                    throw new Error(`Gagal mengambil data dari API, status: ${getResponse.status}`);
                }
                const existingData = await getResponse.json();

                if (!existingData.data || existingData.data.length === 0) {
                    throw new Error('Data tidak ditemukan untuk ID yang diberikan.');
                }

                // Ambil nilai x_05 dan x_08 yang sudah ada
                let x05 = existingData.data[0].x_05 || '';
                let x08 = existingData.data[0].x_08 || '';

                // Langkah 2 & 3: "Explode" string, perbarui elemen kedua
                let x05Parts = x05.split('|');
                x05Parts[1] = `${score}`;
                let newX05Value = x05Parts.join('|');

                let x08Parts = x08.split('|');
                // Menggabungkan array allSelectedAnswers menjadi satu string
                const allAnswersString = answers.map(arr => arr.join(', ')).join('; ');
                x08Parts[1] = allAnswersString;
                let newX08Value = x08Parts.join('|');
                
                // Langkah 4: Siapkan data untuk permintaan PUT
                const formData = {
                    x_05: newX05Value,
                    x_08: newX08Value
                };

                // Langkah 5: Kirim permintaan PUT ke API
                const putUrl = `${API_URL}?table=${TABLE_NAME}&id_x=${id}`;
                console.log('Updating data via PUT to URL:', putUrl);
                console.log('Data to be sent:', formData);
                
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Table-Name': TABLE_NAME
                    },
                    body: JSON.stringify(formData)
                });

                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(errorData.error || `HTTP error! status: ${putResponse.status}`);
                }

                const data = await putResponse.json();
                console.log('Save API response:', data);

                // Perbarui pesan di UI setelah sukses
                apiStatusDiv.innerHTML = `<p style="color: green;">Data berhasil disimpan!</p>`;

                // Alihkan ke index.html setelah 2 detik
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving data:', error);
                // Perbarui pesan di UI jika terjadi error
                apiStatusDiv.innerHTML = `<p style="color: red;">Error menyimpan data: ${error.message || error}</p>`;
            }
        }
    </script>

</body>
</html>
