<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soal Psikotest</title>
    <script>
        if (!localStorage.getItem('user')) {
            window.location.href = 'login.html';
        }
    </script>
    <!-- CSS yang diambil dari file eksternal -->
    <link rel="stylesheet" href="css_tes.css">
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="quiz-container">
        <div class="keterangan_soal">
            <h1>Keterangan Soal</h1>
            <p>Berikut ini adalah persoalan bahasa. Anda akan disediakan 3 kata-kata dan diminta untuk mencari kata ke-4. Kata ke-4 itu mempunyai hubungan tertentu dengan kata ke-3, seperti hubungan yang ada antara kata ke-1 dan kata ke-2.</p>
            <h2>Contoh 1</h2>
            <img src="https://latihan1.pages.dev/01/test/gambar/tkd3_1a.png" alt="">
            <h2>Contoh 2</h2>
            <img src="https://latihan1.pages.dev/01/test/gambar/tkd3_1b.png" alt="">
            <h2>Penjelasan Jawaban</h2>
            <b>Contoh pertama</b>
            <p>Jika anda perhatikan hubungan antara nuri dan burung adalah bahwa nuri merupakan salah satu jenis burung, maka hubungan antara sepat dan salah satu kata pilihan ialah Sepat merupakan salah satu jenis ikan. Oleh karena itu, jawaban yang tepat adalah b. ikan</p>
            <b>Contoh kedua</b>
            <p>Panas ialah lawannya dari dingin, maka untuk suka lawannya adalah duka. Maka jawaban yang benar ialah c. Duka.</p>
        <h1 class="sembunyikan">Kerjakan Dengan Teliti</h1>
        </div>
        <button id="startButton" onclick="startGame()">Start</button>
        <div id="question" class="hidden"></div>
        <div class="options hidden"></div>
        <div id="timer">Waktu Tersisa: 360 detik</div>
        <div class="result" id="result"></div>
        <div style="color: #f4f4f4; user-select: none; pointer-events: none;">Jawaban Pengguna: <span id="userAnswers"></span></div>
    </div>

    <script>
        let correctScore = 0;
        let wrongScore = 0;
        let timeLeft = 360;
        let currentQuestionIndex = 0;
        let questions = [];
        let userAnswers = [];
        let timerInterval;

        // Konfigurasi API untuk menyimpan hasil
        const API_URL = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis';
        const TABLE_NAME = 'nilai1';
        const ID_TO_UPDATE = parseInt(localStorage.getItem('id_x')); // ID data yang akan di-update

        // Mendefinisikan URL dasar untuk file pertanyaan
        const QUESTIONS_URL = 'https://latihan1.pages.dev/01/test/psikotest/tkd3.txt';

        // Mengirim hasil kuis ke API dengan memperbarui elemen keenam belas (indeks 15) dari kolom x_05 dan x_08.
        async function sendResultToApi(score, answers) {
            const id = ID_TO_UPDATE;
            const resultDiv = document.getElementById("result");
            
            // Tampilkan pesan loading
            resultDiv.innerHTML = `<p style="color: blue;">Memproses data dan mengirim ke server...</p>`;

            try {
                // Langkah 1: Ambil data yang ada dari API
                const getUrl = `${API_URL}?table=${TABLE_NAME}&id_x_eq=${id}`;
                console.log('Fetching existing data from URL:', getUrl);
                const getResponse = await fetch(getUrl, {
                    method: 'GET',
                    headers: {
                        'X-Table-Name': TABLE_NAME
                    }
                });

                if (!getResponse.ok) {
                    throw new Error(`Gagal mengambil data dari API, status: ${getResponse.status}`);
                }
                const existingData = await getResponse.json();

                if (!existingData.data || existingData.data.length === 0) {
                    throw new Error('Data tidak ditemukan untuk ID yang diberikan.');
                }

                // Ambil nilai x_05 dan x_08 yang sudah ada
                let x05 = existingData.data[0].x_05 || '';
                let x08 = existingData.data[0].x_08 || '';

                // Langkah 2 & 3: "Explode" string, perbarui elemen keenam belas (indeks 15)
                let x05Parts = x05.split('|');
                // Pastikan array memiliki setidaknya 16 elemen sebelum diupdate
                while (x05Parts.length <= 15) {
                    x05Parts.push('');
                }
                x05Parts[15] = `${score}`;
                let newX05Value = x05Parts.join('|');

                let x08Parts = x08.split('|');
                while (x08Parts.length <= 15) {
                    x08Parts.push('');
                }
                x08Parts[15] = answers.join(', ');
                let newX08Value = x08Parts.join('|');
                
                // Langkah 4: Siapkan data untuk permintaan PUT
                const formData = {
                    x_05: newX05Value,
                    x_08: newX08Value
                };

                // Langkah 5: Kirim permintaan PUT ke API
                const putUrl = `${API_URL}?table=${TABLE_NAME}&id_x=${id}`;
                console.log('Updating data via PUT to URL:', putUrl);
                console.log('Data to be sent:', formData);
                
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Table-Name': TABLE_NAME
                    },
                    body: JSON.stringify(formData)
                });

                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(errorData.error || `HTTP error! status: ${putResponse.status}`);
                }

                const data = await putResponse.json();
                console.log('Save API response:', data);

                // Perbarui pesan di UI setelah sukses
                resultDiv.innerHTML = `<p style="color: green;">Data berhasil disimpan!</p>`;

                // Alihkan ke index.html setelah 2 detik
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving data:', error);
                // Perbarui pesan di UI jika terjadi error
                resultDiv.innerHTML = `<p style="color: red;">Error menyimpan data: ${error.message || error}</p>`;
            }
        }
        
        // Muat status permainan dari localStorage
        function loadGameState() {
            const savedState = localStorage.getItem('gameTkd15');
            if (savedState) {
                const state = JSON.parse(savedState);
                correctScore = state.correctScore || 0;
                wrongScore = state.wrongScore || 0;
                currentQuestionIndex = state.currentQuestionIndex || 0;
                userAnswers = state.userAnswers || [];
                timeLeft = state.timeLeft || 360;
            }
        }

        // Simpan status permainan ke localStorage
        function saveGameState() {
            const gameState = {
                correctScore: correctScore,
                wrongScore: wrongScore,
                currentQuestionIndex: currentQuestionIndex,
                userAnswers: userAnswers,
                timeLeft: timeLeft
            };
            localStorage.setItem('gameTkd15', JSON.stringify(gameState));
        }

        // Mengambil pertanyaan dari file tkd3.txt
        fetch(QUESTIONS_URL)
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal memuat pertanyaan: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            questions = data;
            loadGameState();
        })
        .catch(error => {
            console.error('Error fetching the questions:', error);
            document.getElementById("question").innerHTML = "Gagal memuat soal. Pastikan Anda menjalankan file ini di server web.";
            document.getElementById("question").classList.remove("hidden");
            document.getElementById("startButton").disabled = true;
        });

        function startGame() {
            document.querySelector(".sembunyikan").classList.add("hidden");
            document.querySelector(".keterangan_soal").classList.add("hidden");
            document.getElementById("startButton").disabled = true;
            document.querySelector("h1").classList.add("hidden");
            startTimer();
            newQuestion();
            document.querySelector(".options").classList.remove("hidden");
            document.getElementById("question").classList.remove("hidden");
        }
        
        function startTimer() {
            timerInterval = setInterval(function() {
                timeLeft--;
                document.getElementById("timer").innerHTML = "Waktu Tersisa: " + timeLeft + " detik";
                saveGameState();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(true);
                }
            }, 1000);
        }

        function newQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame(false);
                return;
            }

            const currentQuestion = questions[currentQuestionIndex];
            const correctAnswer = currentQuestion.answer;

            document.getElementById("question").innerHTML = currentQuestion.question;

            const optionsDiv = document.querySelector(".options");
            optionsDiv.innerHTML = "";

            for (const option in currentQuestion.options) {
                if (currentQuestion.options[option] !== undefined) {
                    const button = document.createElement("button");
                    button.innerHTML = `${option}. ${currentQuestion.options[option]}`;
                    button.onclick = () => submitAnswer(option, correctAnswer);
                    optionsDiv.appendChild(button);
                }
            }
            
            const skipButton = document.createElement("button");
            skipButton.innerHTML = "Lewati";
            skipButton.onclick = skipQuestion;
            optionsDiv.appendChild(skipButton);
        }

        function submitAnswer(option, correctAnswer) {
            const questionText = questions[currentQuestionIndex].question;
            const questionNumber = questionText.split('.')[0];
            const resultIndicator = (option === correctAnswer) ? 'v' : 'x';
            userAnswers.push(`${questionNumber}${option}${resultIndicator}`);

            if (option === correctAnswer) {
                correctScore++;
            } else {
                wrongScore++;
            }
            
            document.getElementById("userAnswers").innerHTML = userAnswers.join('; ');

            currentQuestionIndex++;
            saveGameState();
            newQuestion();
        }

        function skipQuestion() {
            questions.push(questions[currentQuestionIndex]);
            currentQuestionIndex++;
            newQuestion();
            saveGameState();
        }

        function endGame(timeout) {
            clearInterval(timerInterval);
            document.querySelector(".options").classList.add("hidden");

            let finalMessage = "";
            if (timeout) {
                finalMessage = "Waktu Habis! Kuis selesai.";
            } else {
                finalMessage = "Soal telah selesai!";
            }

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `
            <div style="text-align: center;">
            <h2>${finalMessage}</h2>
            <p id="apiStatus">Data sedang dikirim ke server...</p>
            </div>
            `;
            
            // Panggil fungsi untuk mengirim data ke API
            sendResultToApi(correctScore, userAnswers);

            localStorage.removeItem('gameTkd15');
        }

        loadGameState();
    </script>

</body>
</html>
