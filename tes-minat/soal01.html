<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soal Psikotest</title>
    <script>
        if (!localStorage.getItem('user')) {
            window.location.href = 'login.html';
        }
    </script>
    <link rel="stylesheet" href="css_tes.css">
</head>
<body>

    <div class="keterangan_soal">
        <h1>Keterangan Soal</h1>
        <p>Tes ini terdiri dari 4 subtes yang masing-masing memiliki durasi waktu tersendiri, jadi harap anda mengerjakannya secepat dan setepat mungkin. Pada subtes pertama ini anda diminta untuk melengkapi kotak keempat pada tiap soal. Di contoh pertama ini, Anda akan menemukan sederet kotak yang berisi urutan gambar. Namun kotak terakhir belum ada isinya. Perlu Anda ingat bahwa kotak tersebut adalah pola yang berkesinambungan.Tugas Anda memilih jawaban yang sesuai, yang bisa dipilih dari 6 pilihan jawaban.</p>
        <h2>Contoh 1</h2>
        <img src="https://latihan1.pages.dev/01/test/gambar/cfit1a.png" alt="">
        <h2>Contoh 2</h2>
        <img src="https://latihan1.pages.dev/01/test/gambar/cfit1b.png" alt="">
        <h2>Penjelasan Jawaban</h2>
        <b>Contoh pertama</b>
        <p>Perhatikan dengan seksama pola yang ada dalam kotak-kotak di atas. Setiap gambar menunjukkan sebuah ranting dengan cabang-cabang kecil. Jika diamati, ada perubahan bertahap dari satu gambar ke gambar berikutnya. Pada kotak pertama, ranting memiliki dua cabang yang mengarah sedikit ke atas, pada kotak kedua, posisi cabang mulai sedikit lebih miring ke bawah. Dan pada kotak ketiga, cabang semakin turun lebih jauh dibandingkan gambar sebelumnya. Dari pola ini, kita bisa menyimpulkan bahwa semakin ke kanan, cabang kecil pada ranting semakin menunduk atau mengarah ke bawah. Jika diperhatikan, jawaban C adalah yang paling sesuai, karena posisi cabangnya lebih turun dibandingkan gambar sebelumnya, sesuai dengan pola perubahan dalam urutan gambar.</p>
        <b>Contoh kedua</b>
        <p>Bayangkan bahwa bagian berwarna dalam gambar ini adalah tirai yang sedang diturunkan secara bertahap. Jika kita memperhatikan gambar dari kiri ke kanan, kita bisa melihat bahwa tirai semakin lama semakin turun menutupi bagian bawah kotak. Pada kotak pertama, tirai masih berada di bagian atas, hanya menutupi sedikit bagian atas kotak., pada kotak kedua, tirai mulai turun lebih rendah, menutupi lebih banyak bagian kotak dan pada gambar ketiga, tirai semakin turun lebih jauh, hampir mencapai bagian tengah kotak. Dari pola ini, kita dapat melihat bahwa tirai terus bergerak turun sedikit demi sedikit dalam setiap langkah. Jawaban yang benar harus mengikuti pola ini, yaitu tirai semakin turun lebih jauh lagi. Jika diperhatikan, jawaban E adalah yang paling sesuai, karena tirai sudah hampir sepenuhnya turun, menutupi lebih banyak bagian bawah kotak.</p>
    <h1>Kerjakan Dengan Teliti</h1>
    </div>

    <button id="startButton" onclick="startGame()">Start</button>
    <div class="image">
        <div id="question" class="hidden"></div>
        <div class="options hidden"></div>
    </div>
    <div id="timer">Waktu Tersisa: 240 detik</div>

    <script>
        let correctScore = 0;
        let wrongScore = 0;
        let timeLeft = 240;
        let currentQuestionIndex = 0;
        let currentQuestion, correctAnswer;
        let answeredQuestions = [];
        let skippedQuestions = [];
        let questions = [];
        let userAnswers = [];
        let timerInterval;

        // Konfigurasi API untuk menyimpan hasil
        const API_URL = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis';
        const TABLE_NAME = 'nilai1';
        const ID_TO_UPDATE = parseInt(localStorage.getItem('id_x')); // ID data yang akan di-update

        // Mendefinisikan URL dasar untuk file pertanyaan (cfit1.txt)
        const QUESTIONS_BASE_URL = 'https://latihan1.pages.dev/01/test/psikotest/';
        // Mendefinisikan URL dasar untuk gambar-gambar
        const IMAGES_BASE_URL = 'https://latihan1.pages.dev/01/test/';

        // Mengambil pertanyaan dari file cfit1.txt
        fetch(QUESTIONS_BASE_URL + 'cfit1.txt?v=' + new Date().getTime())
        .then(response => {
            if (!response.ok) {
                throw new Error('Gagal memuat pertanyaan: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            questions = data;
            loadGameState();
        })
        .catch(error => {
            console.error('Error fetching the questions:', error);
            // Menampilkan pesan kesalahan di UI
            document.getElementById("question").innerHTML = "Gagal memuat soal. Pastikan Anda menjalankan file ini di server web.";
            document.getElementById("question").classList.remove("hidden");
            document.getElementById("startButton").disabled = true;
        });

        function loadGameState() {
            const savedState = localStorage.getItem('gameCfit1');
            if (savedState) {
                const state = JSON.parse(savedState);
                correctScore = state.correctScore || 0;
                wrongScore = state.wrongScore || 0;
                currentQuestionIndex = state.currentQuestionIndex || 0;
                userAnswers = state.userAnswers || [];
                timeLeft = state.timeLeft || 240;
            }
        }

        function startGame() {
            document.querySelector(".keterangan_soal").classList.add("hidden");
            document.getElementById("startButton").disabled = true;
            document.querySelector("h1").classList.add("hidden");
            startTimer();
            newQuestion();
            document.querySelector(".options").classList.remove("hidden");
            document.getElementById("question").classList.remove("hidden");
        }

        function startTimer() {
            timerInterval = setInterval(function() {
                timeLeft--;
                document.getElementById("timer").innerHTML = "Waktu Tersisa: " + timeLeft + " detik";
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(true);
                } else {
                    saveGameState();
                }
            }, 1000);
        }

        function newQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endGame(false);
                return;
            }

            currentQuestion = questions[currentQuestionIndex];
            correctAnswer = currentQuestion.answer;

            // Ambil URL gambar dari pertanyaan
            // Asumsi format: "1. 1.1.jpg" atau "1. cfit/1.1.jpg"
            const questionNumber = currentQuestion.question.split('.')[0];
            let questionImageSrc = currentQuestion.question.split(' ')[1];
            // Hapus jalur ganda jika ada, misal: 'cfit/1.1.jpg' menjadi '1.1.jpg'
            if (questionImageSrc && questionImageSrc.startsWith('cfit/')) {
                questionImageSrc = questionImageSrc.substring(5);
            }
            const fullQuestionImageUrl = IMAGES_BASE_URL + questionImageSrc;

            // Tampilkan pertanyaan (nomor dan gambar) dengan URL absolut
            document.getElementById("question").innerHTML = `${questionNumber}. <img class="question-image" src="${fullQuestionImageUrl}" alt="">`;
            console.log("Memuat gambar soal dari:", fullQuestionImageUrl);

            const optionsDiv = document.querySelector(".options");
            optionsDiv.innerHTML = ""; // Bersihkan opsi sebelumnya

            // Buat gambar untuk setiap opsi dengan URL absolut
            for (const option in currentQuestion.options) {
                if (currentQuestion.options[option] !== undefined) {
                    const img = document.createElement("img");
                    let optionImageSrc = currentQuestion.options[option];
                     // Hapus jalur ganda jika ada
                     if (optionImageSrc && optionImageSrc.startsWith('cfit/')) {
                        optionImageSrc = optionImageSrc.substring(5);
                    }
                    const fullOptionImageUrl = IMAGES_BASE_URL + optionImageSrc;
                    img.src = fullOptionImageUrl;
                    img.alt = optionImageSrc;
                    img.onclick = () => submitAnswer(option);
                    optionsDiv.appendChild(img);
                    console.log("Memuat gambar opsi dari:", fullOptionImageUrl);
                }
            }

            // Tambahkan tombol lewati
            const skipButton = document.createElement("button");
            skipButton.innerHTML = "Lewati";
            skipButton.onclick = skipQuestion;
            optionsDiv.appendChild(skipButton);
        }

        function submitAnswer(option) {
            answeredQuestions.push({
                question: currentQuestion.question,
                userAnswer: option,
                correctAnswer: correctAnswer
            });

            const questionNumber = currentQuestion.question.split('.')[0];
            const resultIndicator = (option === correctAnswer) ? 'v' : 'x';
            userAnswers.push(`${questionNumber}${option}${resultIndicator}`);

            if (option === correctAnswer) {
                correctScore++;
            } else {
                wrongScore++;
            }

            currentQuestionIndex++;
            newQuestion();
            saveGameState();
        }

        function endGame(timeout) {
            clearInterval(timerInterval);
            document.querySelector(".options").classList.add("hidden");

            let finalMessage = "";
            if (timeout) {
                finalMessage = "Waktu Habis, kuis selesai!";
            } else {
                finalMessage = "Soal telah selesai, semua telah dikerjakan!";
            }

            // Tampilkan hanya pesan akhir dan status pengiriman data
            document.getElementById("question").innerHTML = `
            <div style="text-align: center;">
            <h2>${finalMessage}</h2>
            <p id="apiStatus">Data sedang dikirim ke server...</p>
            </div>
            `;

            document.querySelectorAll(".options img").forEach(img => img.onclick = null);
            localStorage.removeItem('gameCfit1');

            // Panggil fungsi untuk mengirim data ke API
            sendResultToApi(correctScore, userAnswers);
        }

        /**
         * Mengirim hasil kuis ke API dengan memperbarui elemen pertama dari kolom x_05 dan x_08.
         * @param {number} score - Skor jawaban yang benar.
         * @param {string[]} answers - Array dari jawaban pengguna.
         */
         async function sendResultToApi(score, answers) {
            const id = ID_TO_UPDATE;
            const apiStatusDiv = document.getElementById("apiStatus");
            
            // Tampilkan pesan loading
            apiStatusDiv.innerHTML = `<p style="color: blue;">Memproses data dan mengirim ke server...</p>`;

            try {
                // Langkah 1: Ambil data yang ada dari API
                const getUrl = `${API_URL}?table=${TABLE_NAME}&id_x_eq=${id}`;
                console.log('Fetching existing data from URL:', getUrl);
                const getResponse = await fetch(getUrl, {
                    method: 'GET',
                    headers: {
                        'X-Table-Name': TABLE_NAME
                    }
                });

                if (!getResponse.ok) {
                    throw new Error(`Gagal mengambil data dari API, status: ${getResponse.status}`);
                }
                const existingData = await getResponse.json();

                if (!existingData.data || existingData.data.length === 0) {
                    throw new Error('Data tidak ditemukan untuk ID yang diberikan.');
                }

                // Ambil nilai x_05 dan x_08 yang sudah ada
                let x05 = existingData.data[0].x_05 || '';
                let x08 = existingData.data[0].x_08 || '';

                // Langkah 2 & 3: "Explode" string, perbarui elemen pertama
                let x05Parts = x05.split('|');
                x05Parts[0] = `${score}`;
                let newX05Value = x05Parts.join('|');

                let x08Parts = x08.split('|');
                x08Parts[0] = answers.join(', ');
                let newX08Value = x08Parts.join('|');
                
                // Langkah 4: Siapkan data untuk permintaan PUT
                const formData = {
                    x_05: newX05Value,
                    x_08: newX08Value
                };

                // Langkah 5: Kirim permintaan PUT ke API
                const putUrl = `${API_URL}?table=${TABLE_NAME}&id_x=${id}`;
                console.log('Updating data via PUT to URL:', putUrl);
                console.log('Data to be sent:', formData);
                
                const putResponse = await fetch(putUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Table-Name': TABLE_NAME
                    },
                    body: JSON.stringify(formData)
                });

                if (!putResponse.ok) {
                    const errorData = await putResponse.json();
                    throw new Error(errorData.error || `HTTP error! status: ${putResponse.status}`);
                }

                const data = await putResponse.json();
                console.log('Save API response:', data);

                // Perbarui pesan di UI setelah sukses
                apiStatusDiv.innerHTML = `<p style="color: green;">Data berhasil disimpan!</p>`;

                // Alihkan ke index.html setelah 2 detik
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('Error saving data:', error);
                // Perbarui pesan di UI jika terjadi error
                apiStatusDiv.innerHTML = `<p style="color: red;">Error menyimpan data: ${error.message || error}</p>`;
            }
        }

        function skipQuestion() {
            skippedQuestions.push(currentQuestion);
            questions.push(currentQuestion);
            currentQuestionIndex++;
            newQuestion();
            saveGameState();
        }

        function saveGameState() {
            const gameState = {
                correctScore: correctScore,
                wrongScore: wrongScore,
                currentQuestionIndex: currentQuestionIndex,
                userAnswers: userAnswers,
                timeLeft: timeLeft
            };
            localStorage.setItem('gameCfit1', JSON.stringify(gameState));
        }
    </script>

</body>
</html>
